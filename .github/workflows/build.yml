name: Build

on:
  pull_request:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  VCPKG_ROOT: ${{ github.workspace }}/external/vcpkg

jobs:
  # ---------------------- Windows: MSVC + GCC + Clang ----------------------
  windows:
    name: Windows (${{ matrix.toolchain }} | ${{ matrix.config }})
    runs-on: windows-2022
    strategy:
      fail-fast: false
      matrix:
        toolchain: [ msvc, gcc, clang ]
        config:    [ Debug, Release ]

    steps:
      - name: Checkout (with submodules)
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Ensure LF line endings + exec bit
        shell: bash
        run: |
          git config core.autocrlf false
          chmod +x scripts/*.sh

      - name: Set up MSVC environment
        if: matrix.toolchain != 'gcc'
        uses: ilammy/msvc-dev-cmd@v1

      - name: Install LLVM for clang-cl
        if: matrix.toolchain == 'clang'
        shell: bash
        run: choco install -y llvm --no-progress || true

      - name: Remove preinstalled MSYS2 (if present)
        if: matrix.toolchain == 'gcc'
        shell: bash
        run: rm -rf /c/msys64 || true

      - name: Set up MSYS2 (mingw64)
        if: matrix.toolchain == 'gcc'
        uses: msys2/setup-msys2@v2
        with:
          update: true
          msystem: MINGW64
          location: C:\
          install: >-
            base-devel
            git
            mingw-w64-x86_64-cmake
            mingw-w64-x86_64-ninja
            mingw-w64-x86_64-gcc

      - name: Setup (vcpkg etc) — MSVC/Clang
        if: matrix.toolchain != 'gcc'
        shell: bash
        run: ./scripts/setup.sh

      - name: Setup (vcpkg etc) — GCC
        if: matrix.toolchain == 'gcc'
        shell: msys2 {0}
        run: ./scripts/setup.sh

      - name: Build — MSVC
        if: matrix.toolchain == 'msvc'
        shell: bash
        run: ./scripts/build.sh -t ${{ matrix.toolchain }} -c ${{ matrix.config }}

      - name: Build — GCC
        if: matrix.toolchain == 'gcc'
        shell: msys2 {0}
        run: ./scripts/build.sh -t ${{ matrix.toolchain }} -c ${{ matrix.config }}

      - name: Build — Clang
        if: matrix.toolchain == 'clang'
        shell: bash
        run: ./scripts/build.sh -t ${{ matrix.toolchain }} -c ${{ matrix.config }}

      - name: Tests — MSVC
        if: matrix.config == 'Debug' && matrix.toolchain == 'msvc'
        shell: bash
        run: ctest --preset win-msvc-tests --output-on-failure

      - name: Tests — GCC
        if: matrix.config == 'Debug' && matrix.toolchain == 'gcc'
        shell: msys2 {0}
        run: ctest --preset win-mingw-gcc-tests --output-on-failure

      - name: Tests — Clang
        if: matrix.config == 'Debug' && matrix.toolchain == 'clang'
        shell: bash
        run: ctest --preset win-clangcl-tests --output-on-failure

      - name: Upload app artifact
        uses: actions/upload-artifact@v4
        with:
          name: app-${{ matrix.toolchain }}-${{ matrix.config }}-windows
          path: |
            build/win-msvc/app/${{ matrix.config }}/
            build/win-mingw-gcc/app/${{ matrix.config }}/
            build/win-clangcl/app/${{ matrix.config }}/
          if-no-files-found: ignore

  # ---------------------- Linux: GCC + Clang ----------------------
  linux:
    name: Linux (${{ matrix.toolchain }} | ${{ matrix.config }})
    runs-on: ubuntu-24.04
    strategy:
      fail-fast: false
      matrix:
        toolchain: [ gcc, clang ]
        config:    [ Debug, Release ]
    steps:
      - name: Checkout (with submodules)
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install deps
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential ninja-build cmake clang

      - name: Ensure exec bit
        run: chmod +x scripts/*.sh

      - name: Setup (vcpkg etc)
        run: ./scripts/setup.sh

      - name: Build — GCC
        if: matrix.toolchain == 'gcc'
        run: ./scripts/build.sh -t ${{ matrix.toolchain }} -c ${{ matrix.config }}

      - name: Build — Clang
        if: matrix.toolchain == 'clang'
        run: ./scripts/build.sh -t ${{ matrix.toolchain }} -c ${{ matrix.config }}

      - name: Tests — GCC
        if: matrix.config == 'Debug' && matrix.toolchain == 'gcc'
        run: ctest --preset linux-gcc-tests --output-on-failure

      - name: Tests — Clang
        if: matrix.config == 'Debug' && matrix.toolchain == 'clang'
        run: ctest --preset linux-clang-tests --output-on-failure

      - name: Upload app artifact
        uses: actions/upload-artifact@v4
        with:
          name: app-${{ matrix.toolchain }}-${{ matrix.config }}-linux
          path: |
            build/linux-gcc/app/${{ matrix.config }}/
            build/linux-clang/app/${{ matrix.config }}/
          if-no-files-found: ignore

  # ---------------------- macOS: AppleClang ----------------------
  macos:
    name: macOS (${{ matrix.toolchain }} | ${{ matrix.config }})
    runs-on: macos-14
    strategy:
      fail-fast: false
      matrix:
        toolchain: [ appleclang ]
        config:    [ Debug, Release ]
    steps:
      - name: Checkout (with submodules)
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install deps
        run: |
          brew update
          brew install ninja cmake
          # For Homebrew GCC job
          if [[ "${{ matrix.toolchain }}" == "gcc" ]]; then
            brew install gcc
          fi

      - name: Ensure exec bit
        run: chmod +x scripts/*.sh

      - name: Setup (vcpkg etc)
        run: ./scripts/setup.sh

      - name: Build — GCC
        if: matrix.toolchain == 'gcc'
        run: ./scripts/build.sh -t ${{ matrix.toolchain }} -c ${{ matrix.config }}

      - name: Build — AppleClang
        if: matrix.toolchain == 'appleclang'
        run: ./scripts/build.sh -t ${{ matrix.toolchain }} -c ${{ matrix.config }}

      - name: Tests — AppleClang
        if: matrix.config == 'Debug' && matrix.toolchain == 'appleclang'
        run: ctest --preset mac-appleclang-tests --output-on-failure

      - name: Upload app artifact
        uses: actions/upload-artifact@v4
        with:
          name: app-${{ matrix.toolchain }}-${{ matrix.config }}-macos
          path: |
            build/mac-appleclang/app/${{ matrix.config }}/
          if-no-files-found: ignore
